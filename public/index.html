<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Reel Downloader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">
                    <i class="fab fa-instagram mr-3"></i>
                    Instagram Reel Downloader
                </h1>
                <p class="text-blue-100 text-lg">Download करें Instagram reels आसानी से</p>
            </div>

            <!-- Main Card -->
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <!-- Instagram Download Section -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Instagram Reel URL</label>
                        <input type="url" id="reelUrl" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="https://www.instagram.com/reel/ABC123/">
                    </div>

                    <div class="flex gap-4">
                        <button id="reviewBtn" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-search mr-2"></i>Review Video
                        </button>
                        <button id="downloadBtn" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-download mr-2"></i>Download Reel
                        </button>
                    </div>
                </div>

                <!-- Review Result -->
                <div id="reviewResult" class="mt-6 hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">
                        <i class="fas fa-eye mr-2"></i>Video Review
                    </h3>
                    <div id="reviewContent" class="border rounded-lg p-4 bg-blue-50"></div>
                </div>

                <!-- Download Result -->
                <div id="downloadResult" class="mt-6 hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">
                        <i class="fas fa-check-circle mr-2 text-green-600"></i>Download Complete
                    </h3>
                    <div id="downloadContent" class="border border-green-300 rounded-lg p-4 bg-green-50"></div>
                </div>
            </div>

            <!-- Examples -->
            <div class="mt-8 bg-white rounded-2xl shadow-2xl p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">
                    <i class="fas fa-lightbulb mr-2"></i>How to Use
                </h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Steps:</h4>
                        <ol class="text-sm text-gray-600 space-y-1 list-decimal list-inside">
                            <li>Instagram से reel का URL copy करें</li>
                            <li>URL को यहाँ paste करें</li>
                            <li>"Review Video" पर click करें</li>
                            <li>Video details check करें</li>
                            <li>"Download Reel" पर click करें</li>
                        </ol>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Supported URLs:</h4>
                        <div class="space-y-2">
                            <button class="example-url text-sm text-blue-600 hover:text-blue-800 block" data-url="https://www.instagram.com/reel/ABC123/">
                                <i class="fas fa-link mr-1"></i>Standard Reel URL
                            </button>
                            <button class="example-url text-sm text-blue-600 hover:text-blue-800 block" data-url="https://www.instagram.com/username/reel/ABC123/">
                                <i class="fas fa-link mr-1"></i>Profile Reel URL
                            </button>
                            <button class="example-url text-sm text-blue-600 hover:text-blue-800 block" data-url="https://www.instagram.com/p/DEF456/">
                                <i class="fas fa-link mr-1"></i>Post URL
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class InstagramDownloader {
            constructor() {
                this.currentVideoInfo = null;
                this.initElements();
                this.initEventListeners();
            }

            initElements() {
                this.reelUrl = document.getElementById('reelUrl');
                this.reviewBtn = document.getElementById('reviewBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.reviewResult = document.getElementById('reviewResult');
                this.reviewContent = document.getElementById('reviewContent');
                this.downloadResult = document.getElementById('downloadResult');
                this.downloadContent = document.getElementById('downloadContent');
            }

            initEventListeners() {
                this.reviewBtn.addEventListener('click', () => this.handleReview());
                this.downloadBtn.addEventListener('click', () => this.handleDownload());

                // Example URLs
                document.querySelectorAll('.example-url').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.reelUrl.value = e.target.dataset.url;
                    });
                });

                // Enable/disable buttons based on URL input
                this.reelUrl.addEventListener('input', () => {
                    const hasUrl = this.reelUrl.value.trim().length > 0;
                    this.reviewBtn.disabled = !hasUrl;
                    
                    if (!hasUrl) {
                        this.downloadBtn.disabled = true;
                        this.reviewResult.classList.add('hidden');
                        this.downloadResult.classList.add('hidden');
                        this.currentVideoInfo = null;
                    }
                });
            }

            async handleReview() {
                const url = this.reelUrl.value.trim();
                if (!url) {
                    this.showMessage('कृपया Instagram URL डालें।', 'error');
                    return;
                }

                if (!this.isValidInstagramUrl(url)) {
                    this.showMessage('कृपया valid Instagram URL डालें।', 'error');
                    return;
                }

                this.setLoading(this.reviewBtn, true, 'Reviewing...');
                this.reviewResult.classList.add('hidden');
                this.downloadResult.classList.add('hidden');

                try {
                    const response = await fetch('/api/review', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ url: url })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.currentVideoInfo = result.videoInfo;
                        this.displayReviewResult(result.videoInfo);
                        this.downloadBtn.disabled = false;
                    } else {
                        this.showMessage(result.message, 'error');
                        this.downloadBtn.disabled = true;
                    }
                } catch (error) {
                    console.error('Review error:', error);
                    this.showMessage('Review में error आया। कृपया फिर से try करें।', 'error');
                    this.downloadBtn.disabled = true;
                } finally {
                    this.setLoading(this.reviewBtn, false, 'Review Video');
                }
            }

            displayReviewResult(videoInfo) {
                const previewId = 'videoPreview-' + Date.now();
                this.reviewContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h4 class="font-semibold text-blue-800">Video Information</h4>
                            <span class="text-sm text-blue-600 bg-blue-100 px-2 py-1 rounded">Ready to Download</span>
                        </div>
                        
                        <!-- Video Preview -->
                        <div class="bg-gray-100 rounded-lg p-4">
                            <h5 class="font-medium text-gray-800 mb-3">
                                <i class="fas fa-play-circle mr-2"></i>Video Preview
                            </h5>
                            <div class="flex justify-center">
                                <div class="relative" id="${previewId}">
                                    ${videoInfo.thumbnail ? `
                                        <img 
                                            src="${videoInfo.thumbnail}" 
                                            alt="Video Thumbnail" 
                                            class="max-w-full max-h-80 rounded-lg shadow-lg cursor-pointer"
                                            style="max-width: 300px;"
                                            onclick="window.playVideoInline('${videoInfo.previewUrl}', '${previewId}')"
                                            onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                                        >
                                        <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-lg cursor-pointer" onclick="window.playVideoInline('${videoInfo.previewUrl}', '${previewId}')">
                                            <div class="bg-white bg-opacity-90 rounded-full p-4 hover:bg-opacity-100 transition-all">
                                                <i class="fas fa-play text-gray-800 text-3xl ml-1"></i>
                                            </div>
                                        </div>
                                    ` : `
                                        <div class="w-72 h-48 bg-gray-300 rounded-lg flex items-center justify-center cursor-pointer" onclick="window.playVideoInline('${videoInfo.previewUrl}', '${previewId}')">
                                            <div class="text-center">
                                                <div class="bg-white bg-opacity-90 rounded-full p-4 mb-2 inline-block">
                                                    <i class="fas fa-play text-gray-800 text-3xl ml-1"></i>
                                                </div>
                                                <p class="text-gray-600">Click to Play Video</p>
                                            </div>
                                        </div>
                                    `}
                                </div>
                            </div>
                            <div class="mt-3 text-center space-x-2">
                                <button 
                                    onclick="window.playVideoInline('${videoInfo.previewUrl}', '${previewId}')" 
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm"
                                >
                                    <i class="fas fa-play mr-2"></i>Play Here
                                </button>
                                <button 
                                    onclick="window.open('${videoInfo.previewUrl}', '_blank')" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
                                >
                                    <i class="fas fa-external-link-alt mr-2"></i>Open in New Tab
                                </button>
                            </div>
                            <div class="mt-2 text-center">
                                <p class="text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Click "Play Here" to preview on this page, or "Open in New Tab" for external viewing
                                </p>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600"><strong>Title:</strong> ${videoInfo.title}</p>
                                <p class="text-sm text-gray-600"><strong>Type:</strong> ${videoInfo.contentType || 'video/mp4'}</p>
                                ${videoInfo.fileSize ? `<p class="text-sm text-gray-600"><strong>Size:</strong> ${this.formatFileSize(videoInfo.fileSize)}</p>` : ''}
                            </div>
                            <div>
                                <p class="text-sm text-gray-600"><strong>Source:</strong> Instagram</p>
                                <p class="text-sm text-gray-600"><strong>Status:</strong> <span class="text-green-600">Available</span></p>
                            </div>
                        </div>
                        
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                Video preview loaded! Click "Play Here" to watch on this page, or click "Download Reel" to proceed with download.
                            </p>
                        </div>
                    </div>
                `;
                this.reviewResult.classList.remove('hidden');
            }

            async handleDownload() {
                if (!this.currentVideoInfo) {
                    this.showMessage('कृपया पहले video review करें।', 'error');
                    return;
                }

                this.setLoading(this.downloadBtn, true, 'Downloading...');
                this.downloadResult.classList.add('hidden');

                try {
                    const response = await fetch('/api/download', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ url: this.currentVideoInfo.url })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.displayDownloadResult(result);
                    } else {
                        this.showMessage(result.message, 'error');
                    }
                } catch (error) {
                    console.error('Download error:', error);
                    this.showMessage('Download में error आया। कृपया फिर से try करें।', 'error');
                } finally {
                    this.setLoading(this.downloadBtn, false, 'Download Reel');
                }
            }

            displayDownloadResult(result) {
                this.downloadContent.innerHTML = `
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-800 font-semibold">${result.message}</p>
                                <p class="text-sm text-green-700">File size: ${this.formatFileSize(result.fileSize)}</p>
                                <p class="text-sm text-green-700">Filename: ${result.filename}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.downloadVideo('${result.downloadUrl}', '${result.filename}')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center text-sm">
                                    <i class="fas fa-download mr-2"></i>Download
                                </button>
                                <a href="${result.downloadUrl}" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center text-sm">
                                    <i class="fas fa-external-link-alt mr-2"></i>Open
                                </a>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-100 p-3 rounded-lg">
                            <p class="text-sm text-yellow-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>Download Instructions:</strong>
                            </p>
                            <ol class="text-sm text-yellow-700 mt-2 ml-4 list-decimal">
                                <li>Click "Download" button above</li>
                                <li>If download doesn't start, click "Open" to view video</li>
                                <li>Right-click on video and select "Save video as..."</li>
                                <li>Choose location and save the file</li>
                            </ol>
                        </div>
                    </div>
                `;
                this.downloadResult.classList.remove('hidden');
            }

            setLoading(button, loading, text) {
                const icon = button.querySelector('i');
                
                if (loading) {
                    button.disabled = true;
                    icon.className = 'fas fa-spinner fa-spin mr-2';
                    button.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${text}`;
                } else {
                    button.disabled = false;
                    if (text === 'Review Video') {
                        button.innerHTML = '<i class="fas fa-search mr-2"></i>Review Video';
                    } else {
                        button.innerHTML = '<i class="fas fa-download mr-2"></i>Download Reel';
                    }
                }
            }

            showMessage(message, type) {
                const messageEl = document.createElement('div');
                messageEl.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                    type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
                }`;
                messageEl.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i>
                        ${message}
                    </div>
                `;
                
                document.body.appendChild(messageEl);
                
                setTimeout(() => {
                    messageEl.remove();
                }, 5000);
            }

            isValidInstagramUrl(url) {
                const patterns = [
                    // Standard reel URLs
                    /^https?:\/\/(?:www\.)?instagram\.com\/reel\/[A-Za-z0-9_-]+\/?/,
                    // Standard post URLs
                    /^https?:\/\/(?:www\.)?instagram\.com\/p\/[A-Za-z0-9_-]+\/?/,
                    // Standard TV URLs
                    /^https?:\/\/(?:www\.)?instagram\.com\/tv\/[A-Za-z0-9_-]+\/?/,
                    // Profile reel URLs (like: /username/reel/ID/)
                    /^https?:\/\/(?:www\.)?instagram\.com\/[A-Za-z0-9_.]+\/reel\/[A-Za-z0-9_-]+\/?/,
                    // Profile post URLs (like: /username/p/ID/)
                    /^https?:\/\/(?:www\.)?instagram\.com\/[A-Za-z0-9_.]+\/p\/[A-Za-z0-9_-]+\/?/
                ];
                return patterns.some(pattern => pattern.test(url));
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // Global video preview function
        window.playVideoInline = async function(videoUrl, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Show loading
            container.innerHTML = `
                <div class="flex items-center justify-center p-8">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-blue-600 text-3xl mb-2"></i>
                        <p class="text-gray-600">Loading video...</p>
                    </div>
                </div>
            `;

            try {
                // Try to create video element
                const video = document.createElement('video');
                video.className = 'max-w-full max-h-80 rounded-lg shadow-lg';
                video.style.maxWidth = '300px';
                video.controls = true;
                video.preload = 'metadata';
                video.crossOrigin = 'anonymous';

                // Create source elements
                const source1 = document.createElement('source');
                source1.src = `/api/preview?url=${encodeURIComponent(videoUrl)}`;
                source1.type = 'video/mp4';

                const source2 = document.createElement('source');
                source2.src = videoUrl;
                source2.type = 'video/mp4';

                video.appendChild(source1);
                video.appendChild(source2);

                // Handle video load success
                video.addEventListener('loadedmetadata', () => {
                    container.innerHTML = '';
                    container.appendChild(video);
                    video.play().catch(e => {
                        console.log('Autoplay prevented:', e);
                    });
                });

                // Handle video load error
                video.addEventListener('error', () => {
                    container.innerHTML = `
                        <div class="text-center p-8">
                            <div class="bg-yellow-100 rounded-lg p-4 mb-4">
                                <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mb-2"></i>
                                <p class="text-yellow-800 mb-2">Video preview not available due to CORS restrictions</p>
                                <p class="text-sm text-yellow-700">Click the button below to view the video</p>
                            </div>
                            <button 
                                onclick="window.open('${videoUrl}', '_blank')" 
                                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                <i class="fas fa-external-link-alt mr-2"></i>Open Video in New Tab
                            </button>
                        </div>
                    `;
                });

                // Try to load the video
                video.load();

            } catch (error) {
                console.error('Video preview error:', error);
                container.innerHTML = `
                    <div class="text-center p-8">
                        <div class="bg-red-100 rounded-lg p-4 mb-4">
                            <i class="fas fa-exclamation-circle text-red-600 text-2xl mb-2"></i>
                            <p class="text-red-800 mb-2">Failed to load video preview</p>
                            <p class="text-sm text-red-700">Please try opening in a new tab</p>
                        </div>
                        <button 
                            onclick="window.open('${videoUrl}', '_blank')" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            <i class="fas fa-external-link-alt mr-2"></i>Open Video in New Tab
                        </button>
                    </div>
                `;
            }
        };

        // Global download function
        window.downloadVideo = async function(url, filename) {
            try {
                // Show loading message
                const loadingMsg = document.createElement('div');
                loadingMsg.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 bg-blue-500 text-white';
                loadingMsg.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        Preparing download...
                    </div>
                `;
                document.body.appendChild(loadingMsg);

                // Try to download using fetch and blob
                const response = await fetch(url);
                const blob = await response.blob();
                
                // Create download link
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);

                // Remove loading message
                loadingMsg.remove();

                // Show success message
                const successMsg = document.createElement('div');
                successMsg.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 bg-green-500 text-white';
                successMsg.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>
                        Download started!
                    </div>
                `;
                document.body.appendChild(successMsg);
                setTimeout(() => successMsg.remove(), 3000);

            } catch (error) {
                console.error('Download error:', error);
                
                // Remove loading message if exists
                const loadingMsg = document.querySelector('.fixed.bg-blue-500');
                if (loadingMsg) loadingMsg.remove();

                // Show error and fallback
                const errorMsg = document.createElement('div');
                errorMsg.className = 'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 bg-red-500 text-white';
                errorMsg.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        Download failed. Opening video in new tab...
                    </div>
                `;
                document.body.appendChild(errorMsg);
                setTimeout(() => errorMsg.remove(), 3000);

                // Fallback: open in new tab
                window.open(url, '_blank');
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            new InstagramDownloader();
        });
    </script>
</body>
</html>